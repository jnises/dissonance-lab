- [x] piano_gui.rs: Multi-touch support and refactoring
  - [x] Researched egui's multi-touch APIs and event handling
  - [x] Analyzed and documented current single-touch limitations
  - [x] Designed and implemented data structures for tracking multiple pointers per key
  - [x] Updated press/release logic for multi-touch and mouse compatibility
  - [x] Switched from usize to wmidi::Note for key representation
  - [x] Introduced a Semitone type for type safety and clarity
  - [x] Added debug_asserts for key invariants and state consistency
  - [x] Refactored semitone-related functions into Semitone methods
  - [x] Centralized pointer/key state updates with helper methods
  - [x] Simplified and cleaned up old code, extracted rendering logic
  - [x] Separated action generation from rendering in render_key
  - [x] Verified interval_display.rs works with multitouch by design
- [x] Make `shift` behave like a sustain pedal. We want almost infinite sustain to allow the user to hear chord dissonances.
  - [x] Update the gui. pressing and holding shift when you are clicking on a piano key should keep the keys selected. untill you release shift.
  - [x] update the synth to accept sustain pedal input
  - [x] Figure out why the piano gui behaves as if the sustain pedal is always active. except for when you release shift
    - Fixed by modifying the key selection logic: keys are now only added to selected_keys when sustain is active, and removed immediately when released if sustain is not active. Visual rendering was updated to show actively pressed keys even when not sustained.
  - [x] change piano_gui to not toggle the keys anymore. they should be pressed as long as the mouse/touch is pressed, unless sustain pedal/shift is active in which case they should remain pressed until it is released.
  - [x] update midi input to send sustain pedal input to the gui and the synth. in the gui show an indication that sustain pedal is active. this indication should replace the "shift for multi select" label and say "â¬† sustain". Change the colors of the label to indicate that it is active.
- [x] Force dark mode for the theme, even if the user has a light mode os
  - Modified theme.rs to explicitly set dark_mode = true and added a check in app.rs update loop to ensure dark mode remains enforced
- [x] Make pressed, sustained, external, and external sustained keys have slightly different colors in piano_gui
  - Added four distinct color functions: `pressed_key()`, `sustained_key()`, `external_key()`, and `external_sustained_key()` to provide visual differentiation between key states. Updated the render_key logic to use these colors appropriately based on the key's current state.
- [x] Make the synth sustain for a very long time. we want to allow users to really hear how multiple notes sound together
  - Reduced sustain decay rate from 0.00001 to 0.000001 to make notes sustain much longer during the sustain phase (when keys are held or sustain pedal is active)
- [x] Refactor piano_gui::Semitone, PointerId, KeySet, and EternalKeySet into a separate file
  - Created `src/piano_types.rs` to house the shared piano-related types: `Semitone`, `PointerId`, `KeySet`, and `ExternalKeySet`. Updated piano_gui.rs to import these types from the new module, removing code duplication and improving modularity.
- [ ] Refactor out non-gui-specific parts of PianoGui into separate type and file so it can be tested properly. I want to be able to test things like what actions are generated when sustain is held in different ways and keys are pressed in different ways, from gui or externally.
- [ ] Keyboard input from the gui should show in the gui, and should result in actions being sent.
- [ ] Keyboard input from midi should only result in keys being marked as pressed in the gui.
- [ ] Sustain pedal activated by shift should result in action to send pedal input to synth.
- [ ] If a keyboard key in the gui is pressed when it is already sustaining due to sustain pedal, noteoff followed by noteon should be sent.
- [ ] sustain action being triggered by shift should be combined with midi sustain in app.rs to make sure that we send sustain pedal message to the synth when either sustain source is pressed, and send stop sustain pedal message to the synth when both sources are released.
- [ ] Figure out why the synth distorts so much (on mobile at least..)
- [ ] Try increasing the reverb to hear how it sounds
- [ ] model piano string stiffness inharmonicity
- [ ] Change the order of the interval displays so the bottom row shows the first pressed note when using the mouse, and the actual base when using a midi keyboard.
  - [ ] The `KeySet` type needs to keep track of the order of the keys
  - [ ] Modify PianoGui to track the chronological order of mouse key presses
  - [ ] Define what "actual base" means for MIDI keyboard input (e.g., lowest note, root note, etc.) Just assume that it is the lowest note for now.
  - [ ] Add input source tracking to distinguish between mouse and MIDI input for each pressed key. If the input modes are mixed, just do some best effort solution. No need to spend much code for this case.
  - [ ] Modify interval_display.rs to use different ordering logic based on input method
  - [ ] Update the pressed_keys data structure to include ordering/priority information
  - [ ] Test the new ordering behavior with both mouse and MIDI input
- [ ] Make the console output from the audio worklet also forward back to the dev server. perhaps we need to have the audio worklet log using a message instead of straight to console
- [ ] Could the midi input callback be moved out of the rust code to make it lower latency?
- [ ] go through the codebase looking for comments that say what has been changed. as is typical of coding agents. remove those as they are not useful longterm
- [ ] Calculate dissonances using critical bands theory (plomp levelt) instead.
    - This would allow us to calculate the dissonance of entire chords
    - how do we handle the fact that we only show a single octave? just force the calculation to happen on a single central octave?
    - can critical bands theory be made octave normalized?
    - does critical bands theory care about the root? do we need to know which note is the root? can the overtones be extended downwards?
- [ ] The dissonance of the currently held notes should show somewhere prominent
- [ ] We only need one row of dissonances that shows what dissonance a new note would result in.
    - for the second note we show the same as we currently do
    - for more notes we show what chord they would result in
